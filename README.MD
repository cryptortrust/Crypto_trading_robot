# Crypto trading robot

## Background 

This robot was created to help me to exit positions (trailing stops) better, to buy at more appropriate points then 'right now', and also to execute stop losses thoroughly. Out of curiosity, I have also created an integration with Telegram and implemented time analysis to predict price moves inspired by a variation of a well-performing [time series indicator](https://oxfordstrat.com/indicators/td-sequential-2/) used by the Wall Street. The scripts were written for Python 2.7 and have not been tested on Python 3. Currently, 3 exchanges are supported: bittrex, binance, bitmex.

Note that this is not a fully automated bot which works automatically all the time but rather a helper. You will still need to decide at least when to enter into the position and what kind of initial stops to set up. I also recommend to analyse the price action and exit your positions thoroughly in parallel with the script running. 

However, provided that you are running price_logger to collect price data (see below for clarifications), you can leave the bot on for pretty much forever - it will monitor price action on candles of specified lengths (default it 4 hours and 1 day) and will open / close long and short positions (shorts are supported on bitmex only). 
The image below illustrates the logic: 

![candles_logic](images/candles_upd_z.png?raw=true "Candles_logic")

## Files 

There are quite a number of files and folders in the repository - all of them are needed for the robot to work. All this may look confusing so here is a clarification. 

The following folders are in there: 
- 'exchanges' includes a few libraries to work with crypto exchanges (bittrex is available)
- 'ccxt' is a fork of the huge [ccxt library](https://github.com/ccxt/ccxt) which I used to integrate binance and bitmex. Note that the bitmex file is modified to add additional functionality (I will commit to the original ccxt later, but you could use the one located here for now). 
- 'price_log' is a location of files with price data generated by price_logger.py  
- 'system_msg' currently includes system log generated by the telegram monitoring script telegramlib.py
- 'logs_buy' and 'logs_trade' include detailed trading logs generated by loglib.py

The following scripts are used: 
- Exchange_func.py includes wrappers for functions of specific exchanges (from the 'exchange' folder) so that the data has the same format to be processed by other scripts. **Note** that your API keys for exchanges should be specified in config.py.
- Loglib.py is a library with a few logging functions 
- Platformlib.py is a library to detect your OS and return proper folders to launch additional scripts
- Price_logger.py gets price ticker for various exchanges from coinigy api and saves data in price_log folder. **Note** that you will need to configure the list of tokens and exchanges for which you would like to collect price data in config.py. 
- Sqltools.py included a few functions to work with workflow.db sqlite database
- Tdlib.py is used to analyse the price data and return values of time analysis indicators
- Telegramlib.py works with telegram messages (used mostly in daemon). **Note** that you would need to register a telegram bot and configure your tokens / chat id in config.py.
- **Robot.py** is a core script which performs the monitoring of position prices, sells or buys back, executes stop orders. 
- **Smart_buy.py** is a core script used to buy positions immediately or in specific conditions.  
- **Config.py** includes all the settings you need to configure (e.g. time zone, api keys, chat id for telegram, and so on). Timers and price analysis periods are also specified in this file. 
 
## Scripts logic and working scripts 

I was too busy writing the code and did not document what logic had been implemented. You could take a look at the scripts to check this out. Just briefly, the following features are implemented in robot and smart_buy scripts: 
- Chat notifications when market price info is not available and sleeping until trading resumes 
- Error handling (checking if there is enough balance, sum above minimum traded amount, amount is fine, etc.) and logging or actions
- Speedrun mode and simulation mode 
- 'Quick' (5-min interval-based) analysis of confirmations on buys and sells, preventing from being shaken out easily 
- Larger-interval (currently 4H) analysis of price action based on a well-performing indicator for entering and exiting the positions as well as dynamic adjustment of stop loss 
- Dynamic price changes when buying and selling using orderbooks and time elapsed since the start of the task
- Pre-profit and post-profit buybacks after exiting the positions 
- Writing results (gains and losses) in a summary xls file 

Ideally, you should run price_logger non-stop so that you collect historical data which is then used in time analysis. Also, you should run daemon.py which will monitor requests sent through a Telegram chat. 

## How to set things up 

After registering your API keys on exchanges, you would need to specify them in config.py. Also, if you want to use Telegram functionality, create a bot (via botfather), and configure your tokens and chat id in the same file (config.py). 

For price logging, you would need a [Coinigy](https://www.coinigy.com/) account and api keys. I really recommend using Coinigy because otherwise you could be blocked from an exchange api even if you run a few robots without price logging. Generally, grabbing prices frequently from exchanges is not a proper solution as they block too frequent requests. Coinigy allows for sending requests quite often so I switched to using it. Note that you can use the robot without having price data, but this would not be as effective as results based on time analysis. 

A few other tips which are important: 
- Make sure that you specify a personal chat id (not a group chat id) in the Telegramlib.py
- Default terminal to launch the commands is gnome-terminal. If you do not have it, either install it in your environment or change the commands in config.py. On my machine, I am also using a separate profile which specifies that the window should be kept open after a program exits so I see if anything goes wrong. See this [stackoverflow topic](https://stackoverflow.com/questions/4465930/prevent-gnome-terminal-from-exiting-after-execution) for details. 
- If you are using Nix, ensure that you specify the path to scripts in config.py. 

### Setting a telegram bot 

Currently, everyone needs to set their own environment which includes registering the telegram bot, setting its menu (if needed), and specifying tokens & chat id in the telegramlib.py. There are several comprehensive guides on the Internet related to this topic, including [the instructions from the telegram core](https://core.telegram.org/bots#botfather). When running, daemon.py supports the following commands sent in a Telegram chat (you can just copy and paste to botfather when configuring commands): 
- status - show running tasks
- new - run a new take profit (trailing stop) / stop loss task 
- abort - cancel running tasks 
- workflow - launch a workflow which includes starting a buy task and then a take profit (trailing stop) / stop loss task 
- balance - check your balances on exchanges; as I am from Australia, this is displaying balance in AUD through USDT which is not quite accurate
- sellnow - sell a position from running tp/sl task immediately 
- buy - initiate a buy tasks; various modes are supported (including buying in simulation, on breakout, in a regular mode, and immediately)
- stopbuy - cancel an active buy task 
- nlong - create a new record about a long-term holding without any buy/sell tasks
- rmlong - delete records from longs table 
- stoplistener - stop the monitoring bot 
- help - get information on commands parameters and available commands 

You can get clarification on the modes (r/s/rnts and so on) by sending the help command to a telegram bot. 

### Setting an environment 

I would recommend setting up a virtual machine or using a cloud VM so that popping screens do not distract you at your usual working environment. You would need to launch daemon.py (for processing your telegram messages) and price_logger.py (for price updates feeding to tdlib). Please check daemon.py code for available commands and modes. Eventually, you would have an environment like this:  

![screen_example](images/screen_upd.png?raw=true "Screen")

## Using the scripts 

### Some examples of how to use all this 

**Example 1**: You are keen to run a task in simulation mode to see how the robot works. The assumption is that you bought 30 LTC on bittrex for your BTC thinking that selling it later would be a profitable trade. Your price was 0.017, take profit target is 0.02, and stop loss level is 0.015. You only want to test it for the quantity of 20 LTC. You will then have the following lovely chat with the configured Telegram bot: 

![chat_example_1](images/chat_example_1.png?raw=true "Chat_1")

The task will be launched in simulation (even for buybacks). 

**Example 2**: Still careful with actually using this tool, you decide to test buying functionality. Let's say that you are collecting price data through price_logger and that you would like to buy based on 4-hour price action method. You are keen to buy BTC for 5500 USDT on binance for a market price on 4-hour confirmation. Then your chat would be: 

![chat_example_2](images/chat_example_2.png?raw=true "Chat_2")

Similarly, the task will be launched in simulation. 

**Example 3**: Now you see that this stuff works fine and would like to configure something more advanced. For instance, you see that BTC/USDT is looking really bullish and you would like to buy on the breakout at the level of 19650. You consider that your initial take profit target is 20000, you would like to put a tight initial stop loss at 19500, and you are going to spend 5500 USDT. Easy!

![chat_example_3](images/chat_example_3.png?raw=true "Chat_2")

Note that your stop loss will be dynamically reconfigured if you are collecting price data with the price_logger script. 

**Additional examples of supported Telegram commands** :

Open long contracts on bitmex for XBT (BTC) with the total cost of 0.3 BTC (hereinafter, x times the configured margin) with the regular 5-minute candles based confirmation: 
> /buy 

> reg bmex usd-btc 0.3

Open short contracts on bitmex for Ripple (XRPH18) with the total cost of 0.1 BTC immediately: 
> /buy 

> now bmex XRPH18 -0.1 

Open short contracts on bitmex for Ripple (XRPH18) with the total cost of 0.05 BTC on the time-based (default 4H) candles confirmation: 
> /buy 

> 4h bmex XRPH18 -0.05

Buy POWR tokens on bittrex on the breakout of 0.000095 for 0.5 BTC: 
> /buy 

> brk btrx btc-powr 0.5 0.000095

For the whole balance of 25 LTC on the binance exchange, start a task with the entry price of 0.015, take profit price of 0.019, and stop loss level of 0.013. 
> /new

> r bina btc-ltc 0.015 0.019 0.013

Open long contracts for BTC on bitmex on the confirmation of bullishness on 4-hour candles for the total of 0.5 BTC, with the take profit level of 18850 and the stop loss of 15400 
> /workflow

> r bmex 18850 15400

> 4h bmex usd-btc 0.5

### Using price_logger to mitigate the risk of USDT crashing hard 

I genuinely believe that USDT (USD Tether) is a ticking time bomb which will burst one day. However, I had been using it for a while due to its convenience. In order to protect myself from a sudden collapse of this token, I added a piece of code in the price_logger script which monitors the usdt-usd exchange rate (on Kraken) and buys BTC for all the available USDT when USDT collapses (USDT-USD ratio 0.93 for more than 15 minutes which did not happen in the past few years). 

I consider Tether a great instrument and a perfect tool for the provision of better liquidity (especially for alts) - however, I am really  concerned with complete disregard of the community concerns by the Tether company and by Bitfinex. More and more tokens are being 'printed' while the community has to keep guessing what is going on. These companies should come up with a public statement and with transparent audits available to public. 

### Editing the workflow database

This repo includes a dummy database with no records which is a sqlite database (more than enough for the purpose of personal use). You can use any software working with sqlite to edit the tables in case anything goes wrong. 

## Terms of use and non-responsibility clause

Please use the scripts at your own risk. I am not responsible for your API keys being lost or intercepted, as well as your funds lost as a consequence of using the scripts. These scripts have some 'fool or fat fingers' protection included - however, you are fully responsible for secure storage of the scripts and for your course of actions. 

## Contributions 

As there are many other exchanges out there except for included ones, I would appreciate anyone's help in including other exchange APIs and writing a wrapper in exchange_func.py. Moreover, even scripts working with the current exchanges could be improved - in particulat, bitmex commission and realised PNL calculation should be done and tested thoroughly; margin size can be calculated rather than fixed, and additional indicators could be used in combination with time analysis to make better probabilistic trades automatically. Robot messages currently do not correctly show values based on margins and also do not really reflect shorts. All this can be improved.   
Additionally, I would appreciate help in more thorough processing of price/time data and developing a predictive model using sklearn. This would require getting historical data, for example, from [kaggle](https://www.kaggle.com/mczielinski/bitcoin-historical-data), using tdlib for the calculation of parameters, and then training a model based on the data. An example of how this could be done is available at my [Enron project repository](https://github.com/illi4/Enron_fraud). 

Moreover, the code can definitely be cleaned and improved further. E.g. some functions can be separated in modules, and settings can be externalised in a separate file rather than hardcoded. 

Please feel free to contribute on github directly or contact me first via Telegram (illi4).

## Donations

Donations would be much appreciated so that I can spend more time on coding and research. 
- BTC: 3B9PYDa5PFLDo4YqVi6XgVGf9nMfpJhjC9
- ETH: 0xb52770c0F71BF80aa97CCd79fe93f3F6520787Dc
- LTC: M8TUzJMwCsCey4DvGEDHVW4QrMT2hq7zq7
